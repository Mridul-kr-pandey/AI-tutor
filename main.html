<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>AI Tutor Pro ‚Äì Smart PDF to MCQ Generator</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
/* Previous CSS same rahega, space bachane ke liye nahi likh raha */
*{box-sizing:border-box;margin:0;padding:0;font-family:'Segoe UI',sans-serif}
:root{--primary:#6366f1;--primary-dark:#4f46e5;--secondary:#10b981;--accent:#f59e0b;--danger:#ef4444;--dark:#1f2937;--light:#f9fafb;--gray:#6b7280;--border:#e5e7eb}
body{background:linear-gradient(135deg,#667eea,#764ba2);min-height:100vh;padding:20px}
.container{max-width:1200px;margin:auto;background:white;border-radius:24px;overflow:hidden;box-shadow:0 25px 50px rgba(0,0,0,0.25)}
.header{background:linear-gradient(135deg,var(--primary),var(--primary-dark));color:white;padding:30px 40px;text-align:center}
.tabs{display:flex;background:var(--light);padding:0;border-bottom:2px solid var(--border)}
.tab-btn{flex:1;border:none;padding:20px;background:transparent;font-size:16px;font-weight:600;color:var(--gray);cursor:pointer;display:flex;align-items:center;justify-content:center;gap:10px;border-bottom:3px solid transparent}
.tab-btn.active{color:var(--primary);background:white;border-bottom:3px solid var(--primary)}
.section{display:none;padding:30px}
.section.active{display:block}
.chat-box{height:400px;overflow-y:auto;border:1px solid var(--border);padding:20px;background:#f8fafc;border-radius:12px;margin-bottom:15px}
.message{margin-bottom:12px;max-width:80%;padding:12px 16px;border-radius:12px}
.user-message{background:var(--primary);color:white;margin-left:auto;border-bottom-right-radius:5px}
.ai-message{background:white;border:1px solid var(--border);margin-right:auto;border-bottom-left-radius:5px}
.input-row{display:flex;gap:10px}
.input-row textarea{flex:1;padding:12px;border:2px solid var(--border);border-radius:8px;resize:none;min-height:60px}
.btn-primary{background:var(--primary);color:white;border:none;padding:12px 24px;border-radius:8px;cursor:pointer;font-weight:600}
.pdf-upload{text-align:center;padding:40px;border:3px dashed var(--border);border-radius:16px;margin:20px 0;cursor:pointer}
.pdf-upload:hover{border-color:var(--primary)}
.mcq-question{background:var(--light);padding:20px;border-radius:12px;margin-bottom:20px;border-left:4px solid var(--primary)}
.options{margin-top:15px}
.option{display:block;padding:12px;margin-bottom:8px;background:white;border:2px solid var(--border);border-radius:8px;cursor:pointer}
.option:hover{border-color:var(--primary)}
.option.selected{border-color:var(--secondary);background:rgba(16,185,129,0.1)}
.score{background:linear-gradient(135deg,var(--secondary),#34d399);color:white;padding:20px;border-radius:12px;text-align:center;margin-top:20px;font-size:24px;font-weight:bold}
.loading{text-align:center;padding:20px;color:var(--primary)}
.hidden{display:none}
</style>
</head>

<body>
<div class="container">
  <div class="header">
    <h1>ü§ñ AI Tutor Pro</h1>
    <p>PDF ‚Üí MCQ Generator | 100% Working</p>
  </div>

  <div class="tabs">
    <button class="tab-btn active" onclick="showTab('chat')">üí¨ Chat</button>
    <button class="tab-btn" onclick="showTab('test')">üß™ Manual Test</button>
    <button class="tab-btn" onclick="showTab('pdf')">üìÑ PDF to MCQ</button>
  </div>

  <!-- CHAT TAB -->
  <div id="chat" class="section active">
    <div class="chat-box" id="chatBox">
      <div class="message ai-message">
        <strong>Hello! I'm your AI Tutor.</strong><br>
        Ask me anything or use other tabs to generate tests.
      </div>
    </div>
    <div class="input-row">
      <textarea id="chatInput" placeholder="Type your question..."></textarea>
      <button class="btn-primary" onclick="sendChat()">Send</button>
    </div>
  </div>

  <!-- MANUAL TEST TAB -->
  <div id="test" class="section">
    <h2>Create Manual Test</h2>
    <input type="text" id="manualTopic" placeholder="Topic (e.g., Binary Search)" style="width:100%;padding:12px;margin-bottom:10px;border:2px solid var(--border);border-radius:8px">
    <button class="btn-primary" onclick="generateManualTest()" style="width:100%">Generate 5 MCQs</button>
    <div id="manualTestOut" style="margin-top:20px"></div>
  </div>

  <!-- PDF TO MCQ TAB -->
  <div id="pdf" class="section">
    <h2>üìÑ PDF to MCQ Generator</h2>
    
    <div class="pdf-upload" onclick="document.getElementById('pdfFile').click()" id="uploadArea">
      <div style="font-size:48px;color:var(--primary);margin-bottom:15px">
        <i class="fas fa-file-pdf"></i>
      </div>
      <h3>Click to Upload PDF</h3>
      <p>Maximum 10MB | .pdf files only</p>
      <input type="file" id="pdfFile" accept=".pdf" style="display:none" onchange="handlePDFUpload()">
    </div>

    <div id="pdfStatus" style="padding:15px;background:var(--light);border-radius:8px;margin:15px 0">
      No PDF uploaded yet.
    </div>

    <div style="display:flex;gap:10px;margin:20px 0">
      <button class="btn-primary" onclick="extractPDFTopics()" id="extractBtn" disabled>
        Extract Topics
      </button>
      <button class="btn-primary" onclick="generatePDFTest()" id="generateBtn" disabled>
        Generate Test
      </button>
    </div>

    <div id="topicsBox" class="hidden" style="padding:20px;background:var(--light);border-radius:8px;margin:15px 0">
      <h3>üìö Extracted Topics</h3>
      <div id="topicsList"></div>
    </div>

    <div id="pdfTestOut" style="margin-top:20px"></div>
  </div>
</div>

<!-- Font Awesome -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>

<!-- PDF.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
<script>
// PDF.js worker
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

// üî• YOUR API KEY
const API_KEY = "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";

// Global variables
let pdfText = "";
let currentMCQs = [];

// Tab switching
function showTab(tabId) {
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.getElementById(tabId).classList.add('active');
  document.querySelector(`.tab-btn[onclick="showTab('${tabId}')"]`).classList.add('active');
}

// AI Call Function
async function askAI(prompt) {
  try {
    const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
      method: "POST",
      headers: {
        "Authorization": "Bearer " + API_KEY,
        "Content-Type": "application/json",
        "HTTP-Referer": window.location.origin,
        "X-Title": "AI Tutor Pro"
      },
      body: JSON.stringify({
        model: "openai/gpt-3.5-turbo",
        messages: [
          {
            role: "system",
            content: "You are an expert AI tutor. Generate MCQs in valid JSON format only."
          },
          {
            role: "user",
            content: prompt
          }
        ],
        temperature: 0.7,
        max_tokens: 2000
      })
    });

    if (!response.ok) {
      throw new Error(`API Error: ${response.status}`);
    }

    const data = await response.json();
    return data.choices[0].message.content;
  } catch (error) {
    console.error("AI Error:", error);
    return null;
  }
}

// Chat function
async function sendChat() {
  const input = document.getElementById('chatInput');
  const question = input.value.trim();
  if (!question) return;

  const chatBox = document.getElementById('chatBox');
  chatBox.innerHTML += `<div class="message user-message">${question}</div>`;
  input.value = '';

  chatBox.innerHTML += `<div class="message ai-message">Thinking...</div>`;
  
  const response = await askAI(question);
  if (response) {
    chatBox.lastElementChild.innerHTML = response;
  } else {
    chatBox.lastElementChild.innerHTML = "Sorry, I couldn't process your request.";
  }
  
  chatBox.scrollTop = chatBox.scrollHeight;
}

// Handle PDF Upload
async function handlePDFUpload() {
  const fileInput = document.getElementById('pdfFile');
  const file = fileInput.files[0];
  const status = document.getElementById('pdfStatus');
  const uploadArea = document.getElementById('uploadArea');

  if (!file) return;

  // Show loading
  uploadArea.innerHTML = `
    <div style="color: var(--primary)">
      <i class="fas fa-spinner fa-spin" style="font-size:48px"></i>
      <h3>Processing PDF...</h3>
      <p>${file.name}</p>
    </div>
  `;

  status.innerHTML = "Extracting text from PDF...";

  try {
    // Extract text using PDF.js
    const text = await extractPDFText(file);
    pdfText = text;

    // Update UI
    uploadArea.innerHTML = `
      <div style="color: var(--secondary)">
        <i class="fas fa-check-circle" style="font-size:48px"></i>
        <h3>PDF Ready!</h3>
        <p>${file.name}</p>
        <p style="font-size:12px">${text.length.toLocaleString()} characters extracted</p>
      </div>
    `;

    status.innerHTML = `
      ‚úÖ PDF processed successfully!<br>
      <small>Preview: ${text.substring(0, 200)}...</small>
    `;

    // Enable buttons
    document.getElementById('extractBtn').disabled = false;
    document.getElementById('generateBtn').disabled = false;

  } catch (error) {
    console.error("PDF Error:", error);
    uploadArea.innerHTML = `
      <div style="color: var(--danger)">
        <i class="fas fa-times-circle" style="font-size:48px"></i>
        <h3>Upload Failed</h3>
        <p>${error.message}</p>
      </div>
    `;
    status.innerHTML = `‚ùå Error: ${error.message}`;
  }
}

// Extract text from PDF
async function extractPDFText(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    
    reader.onload = async function(event) {
      try {
        const typedArray = new Uint8Array(event.target.result);
        const pdf = await pdfjsLib.getDocument(typedArray).promise;
        let fullText = '';

        // Extract text from first 10 pages (for speed)
        const maxPages = Math.min(pdf.numPages, 10);
        
        for (let i = 1; i <= maxPages; i++) {
          const page = await pdf.getPage(i);
          const textContent = await page.getTextContent();
          const pageText = textContent.items.map(item => item.str).join(' ');
          fullText += pageText + '\n\n';
        }

        if (fullText.trim().length === 0) {
          reject(new Error('No readable text found in PDF'));
        } else {
          resolve(fullText);
        }
      } catch (error) {
        reject(error);
      }
    };

    reader.onerror = function(error) {
      reject(error);
    };

    reader.readAsArrayBuffer(file);
  });
}

// Extract topics from PDF
async function extractPDFTopics() {
  if (!pdfText || pdfText.length < 100) {
    alert("Please upload a PDF first!");
    return;
  }

  const status = document.getElementById('pdfStatus');
  status.innerHTML = "Analyzing PDF content for topics...";

  const prompt = `
    Extract main topics from this PDF content. Return as a bulleted list.

    PDF Content (first 3000 characters):
    ${pdfText.substring(0, 3000)}

    Return only the bulleted list, nothing else.
  `;

  const response = await askAI(prompt);
  if (response) {
    document.getElementById('topicsBox').classList.remove('hidden');
    document.getElementById('topicsList').innerHTML = response.replace(/\n/g, '<br>');
    status.innerHTML = "‚úÖ Topics extracted successfully!";
  } else {
    status.innerHTML = "‚ùå Failed to extract topics.";
  }
}

// Generate test from PDF
async function generatePDFTest() {
  if (!pdfText || pdfText.length < 100) {
    alert("Please upload a PDF first!");
    return;
  }

  const testOut = document.getElementById('pdfTestOut');
  testOut.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> Generating MCQs from PDF...</div>';

  const prompt = `
    Create 5 multiple choice questions based on the following PDF content.
    
    PDF Content (first 4000 characters):
    ${pdfText.substring(0, 4000)}
    
    IMPORTANT: Return ONLY valid JSON in this exact format:
    {
      "mcqs": [
        {
          "question": "Question text here?",
          "options": ["Option A", "Option B", "Option C", "Option D"],
          "answer": 0,
          "explanation": "Brief explanation"
        }
      ]
    }
    
    Rules:
    1. "answer" should be index number (0-3)
    2. Include explanation for each question
    3. Questions should be based ONLY on the PDF content
    4. Make options plausible
  `;

  const response = await askAI(prompt);
  
  if (!response) {
    testOut.innerHTML = '<div style="color:var(--danger)">‚ùå Failed to generate test. Try again.</div>';
    return;
  }

  try {
    // Try to extract JSON from response
    let jsonStr = response.trim();
    
    // Remove markdown code blocks if present
    jsonStr = jsonStr.replace(/```json\n?|\n?```/g, '');
    jsonStr = jsonStr.replace(/```\n?|\n?```/g, '');
    
    // Find JSON object
    const jsonStart = jsonStr.indexOf('{');
    const jsonEnd = jsonStr.lastIndexOf('}') + 1;
    
    if (jsonStart !== -1 && jsonEnd > jsonStart) {
      jsonStr = jsonStr.substring(jsonStart, jsonEnd);
    }
    
    const data = JSON.parse(jsonStr);
    currentMCQs = data.mcqs;
    
    // Display MCQs
    displayMCQs(currentMCQs, 'pdfTestOut');
    
  } catch (error) {
    console.error("JSON Parse Error:", error);
    console.log("Raw Response:", response);
    
    // Fallback: Display raw response
    testOut.innerHTML = `
      <div style="color:var(--danger);margin-bottom:20px">
        ‚ùå Could not parse JSON. Showing raw response:
      </div>
      <pre style="background:#f0f0f0;padding:15px;border-radius:8px;overflow:auto;max-height:300px">
${response}
      </pre>
      <button class="btn-primary" onclick="generatePDFTest()" style="margin-top:15px">
        Try Again
      </button>
    `;
  }
}

// Generate manual test
async function generateManualTest() {
  const topic = document.getElementById('manualTopic').value.trim() || "General Knowledge";
  const testOut = document.getElementById('manualTestOut');
  
  testOut.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> Generating test...</div>';

  const prompt = `
    Create 5 multiple choice questions about: ${topic}
    
    Return ONLY valid JSON in this exact format:
    {
      "mcqs": [
        {
          "question": "Question text?",
          "options": ["A", "B", "C", "D"],
          "answer": 0,
          "explanation": "Explanation"
        }
      ]
    }
    
    Answer should be index (0-3).
  `;

  const response = await askAI(prompt);
  
  if (!response) {
    testOut.innerHTML = '<div style="color:var(--danger)">‚ùå Failed to generate test.</div>';
    return;
  }

  try {
    let jsonStr = response.trim();
    jsonStr = jsonStr.replace(/```json\n?|\n?```/g, '');
    jsonStr = jsonStr.replace(/```\n?|\n?```/g, '');
    
    const jsonStart = jsonStr.indexOf('{');
    const jsonEnd = jsonStr.lastIndexOf('}') + 1;
    
    if (jsonStart !== -1 && jsonEnd > jsonStart) {
      jsonStr = jsonStr.substring(jsonStart, jsonEnd);
    }
    
    const data = JSON.parse(jsonStr);
    currentMCQs = data.mcqs;
    
    displayMCQs(currentMCQs, 'manualTestOut');
    
  } catch (error) {
    console.error("Error:", error);
    testOut.innerHTML = `
      <div style="color:var(--danger)">‚ùå Error. Raw response:</div>
      <pre>${response}</pre>
    `;
  }
}

// Display MCQs
function displayMCQs(mcqs, containerId) {
  const container = document.getElementById(containerId);
  
  if (!mcqs || mcqs.length === 0) {
    container.innerHTML = '<div style="color:var(--danger)">No questions generated.</div>';
    return;
  }

  let html = `<h3>üìù Test Questions (${mcqs.length})</h3>`;
  
  mcqs.forEach((mcq, index) => {
    html += `
      <div class="mcq-question">
        <strong>Q${index + 1}: ${mcq.question}</strong>
        <div class="options" id="options${index}">
    `;
    
    mcq.options.forEach((option, optIndex) => {
      html += `
        <div class="option" onclick="selectOption(${index}, ${optIndex})" id="q${index}o${optIndex}">
          ${String.fromCharCode(65 + optIndex)}) ${option}
        </div>
      `;
    });
    
    html += `
        </div>
        <div id="explanation${index}" style="display:none;margin-top:10px;padding:10px;background:rgba(16,185,129,0.1);border-radius:6px;">
          <strong>Explanation:</strong> ${mcq.explanation || 'No explanation provided.'}
        </div>
      </div>
    `;
  });
  
  html += `
    <button class="btn-primary" onclick="submitTest()" style="width:100%;padding:15px;font-size:16px;margin-top:20px">
      ‚úÖ Submit Test
    </button>
    <div id="resultContainer" style="margin-top:20px"></div>
  `;
  
  container.innerHTML = html;
}

// Select option
function selectOption(questionIndex, optionIndex) {
  // Reset all options for this question
  const options = document.querySelectorAll(`#options${questionIndex} .option`);
  options.forEach(opt => {
    opt.classList.remove('selected');
  });
  
  // Select clicked option
  document.getElementById(`q${questionIndex}o${optionIndex}`).classList.add('selected');
  
  // Show explanation
  document.getElementById(`explanation${questionIndex}`).style.display = 'block';
}

// Submit test
function submitTest() {
  if (!currentMCQs || currentMCQs.length === 0) {
    alert("No test to submit!");
    return;
  }

  let score = 0;
  let results = [];
  
  currentMCQs.forEach((mcq, index) => {
    const selectedOption = document.querySelector(`#options${index} .option.selected`);
    
    if (selectedOption) {
      const optionIndex = parseInt(selectedOption.id.replace(`q${index}o`, ''));
      const isCorrect = optionIndex === mcq.answer;
      
      if (isCorrect) {
        score++;
      }
      
      results.push({
        question: mcq.question,
        selected: optionIndex,
        correct: mcq.answer,
        isCorrect: isCorrect
      });
    } else {
      results.push({
        question: mcq.question,
        selected: null,
        correct: mcq.answer,
        isCorrect: false
      });
    }
  });
  
  const percentage = Math.round((score / currentMCQs.length) * 100);
  
  let resultHtml = `
    <div class="score">
      üéØ Your Score: ${score}/${currentMCQs.length}<br>
      üìä Percentage: ${percentage}%
    </div>
    
    <div style="margin-top:20px;background:white;padding:20px;border-radius:12px;border:2px solid var(--border)">
      <h4>üìã Detailed Results:</h4>
  `;
  
  results.forEach((result, index) => {
    resultHtml += `
      <div style="margin-bottom:15px;padding-bottom:15px;border-bottom:1px solid var(--border);${index === results.length - 1 ? 'border-bottom:none' : ''}">
        <strong>Q${index + 1}:</strong> ${result.question}<br>
        <span style="color:${result.isCorrect ? 'var(--secondary)' : 'var(--danger)'};font-size:14px">
          ${result.selected !== null ? 
            `Your answer: ${String.fromCharCode(65 + result.selected)} | 
             Correct answer: ${String.fromCharCode(65 + result.correct)} | 
             ${result.isCorrect ? '‚úÖ Correct' : '‚ùå Incorrect'}` : 
            '‚ùå Not answered'}
        </span>
      </div>
    `;
  });
  
  resultHtml += `</div>`;
  
  document.getElementById('resultContainer').innerHTML = resultHtml;
  document.getElementById('resultContainer').scrollIntoView({ behavior: 'smooth' });
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
  // Enable Enter key in chat
  document.getElementById('chatInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendChat();
    }
  });
});
</script>
</body>
</html>